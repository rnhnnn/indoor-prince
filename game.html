<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Adventure</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #game { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #000; }
        .scene-text { margin-bottom: 15px; }
        .dialogue { margin-top: 15px; }
        ul { list-style-type: none; padding: 0; }
        .dialogue-choice {
            cursor: pointer; 
            color: blue; 
            text-decoration: underline; 
            margin: 5px 0; 
            display: block;
        }
        .dialogue-choice:hover { color: darkblue; }
        button { display: block; margin-top: 10px; padding: 10px; cursor: pointer; }
        #save-btn {
            position: fixed; 
            top: 10px; 
            right: 10px; 
            padding: 5px;
        }
        #navigation { margin-top: 20px; }
    </style>
</head>
<body>

    <div id="game">
        <!-- Start Menu -->
        <div id="start-menu">
            <h1>Text Adventure</h1>
            <button onclick="startGame()">New Game</button>
            <button onclick="document.getElementById('load-input').click()">Load Game</button>
            <input type="file" id="load-input" style="display: none;" onchange="loadGame(event)">
        </div>

        <!-- Scene Container -->
        <div id="scene-container" style="display: none;"></div>

        <!-- Save Button -->
        <button id="save-btn" style="display: none;" onclick="saveGame()">Save Game</button>
    </div>

    <script>
        const gameData = {
            scenes: {
                "crossroads": {
                    "content": [
                        "You arrive at a crossroads.",
                        "There are two paths ahead."
                    ],
                    "actions": [
                        { "text": "Take the Left Path", "next": "leftScene" },
                        { "text": "Take the Right Path", "next": "rightScene" }
                    ]
                },
                "leftScene": {
                    "content": [
                        "You take the left path and soon notice a cloaked figure standing by the roadside.",
                        "He watches you silently as you approach."
                    ],
                    "dialogue": {
                        "character": "Cloaked Stranger",
                        "options": [
                            { 
                                "text": "Who are you?", 
                                "response": "That is not important.", 
                                "character": "Cloaked Stranger",
                                "id": "q1"
                            },
                            { 
                                "text": "Where does this road lead?", 
                                "response": "It leads where you take it.", 
                                "character": "Cloaked Stranger",
                                "id": "q2"
                            },
                            { 
                                "text": "What are you doing here?", 
                                "response": "Waiting for someone.", 
                                "character": "Mysterious Woman",
                                "id": "q3"
                            },
                            { 
                                "text": "Tell me the truth.", 
                                "response": "Fine. I was once a traveler like you... but now I am lost.", 
                                "id": "q4",
                                "requires": ["q1"] 
                            }
                        ]
                    },
                    "actions": [
                        { "text": "Ignore the man and keep walking", "next": "forestPath" },
                        { "text": "Walk back to the crossroads", "next": "crossroads" }
                    ]
                },
                "rightScene": {
                    "content": [
                        "You take the right path and start collecting interesting rocks.",
                        "You put them in your pocket and continue walking."
                    ],
                    "actions": [
                        { "text": "Go back to the crossroads", "next": "crossroads" }
                    ]
                }
            }
        };

        let currentScene = "crossroads";
        let chosenDialogues = new Set();

        function startGame() {
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('scene-container').style.display = 'block';
            document.getElementById('save-btn').style.display = 'block';
            renderScene(currentScene);
        }

        function renderScene(sceneId) {
            const scene = gameData.scenes[sceneId];
            if (!scene) {
                alert("Scene not found: " + sceneId);
                return;
            }
            currentScene = sceneId;

            let sceneContainer = document.getElementById("scene-container");
            sceneContainer.className = sceneId;
            sceneContainer.innerHTML = "";

            // Scene Content Container (will be updated by dialogue)
            let contentContainer = document.createElement("div");
            contentContainer.id = "content-container";
            sceneContainer.appendChild(contentContainer);

            // Add Initial Scene Content
            updateSceneContent(scene.content);

            // Dialogue Container
            if (scene.dialogue) {
                renderDialogue(scene);
            }

            // Navigation Buttons
            let navigationContainer = document.createElement("div");
            navigationContainer.id = "navigation";
            
            // Add Actions Heading
            let actionsTitle = document.createElement("h3");
            actionsTitle.innerText = "Actions:";
            navigationContainer.appendChild(actionsTitle);

            scene.actions.forEach(action => {
                let btn = document.createElement("button");
                btn.innerText = action.text;
                btn.onclick = () => renderScene(action.next);
                navigationContainer.appendChild(btn);
            });

            sceneContainer.appendChild(navigationContainer);
        }

        function updateSceneContent(paragraphs) {
            let contentContainer = document.getElementById("content-container");
            contentContainer.innerHTML = ""; // Clear previous content

            paragraphs.forEach((text, index) => {
                let p = document.createElement("p");
                p.className = "scene-text";
                p.innerText = text;
                p.style.opacity = "0"; // Start hidden
                contentContainer.appendChild(p);

                // Fade in effect with delay
                setTimeout(() => {
                    p.style.transition = "opacity 0.5s";
                    p.style.opacity = "1";
                }, index * 500); // Adjust timing if needed
            });
        }

        function renderDialogue(scene) {
            let dialogueBox = document.createElement("div");
            dialogueBox.className = "dialogue";

            let title = document.createElement("h3");
            title.innerText = "Dialogue options:";
            dialogueBox.appendChild(title);

            let dialogueList = document.createElement("ul");

            scene.dialogue.options.forEach(option => {
                // Skip options that have already been selected
                if (chosenDialogues.has(option.id)) {
                    return;
                }

                // Check if the option requires previous choices
                if (option.requires && option.requires.length > 0) {
                    // Only show options that have the required previous choices
                    if (!option.requires.every(req => chosenDialogues.has(req))) {
                        return;
                    }
                }

                let li = document.createElement("li");
                li.className = "dialogue-choice";
                li.innerText = option.text;
                li.onclick = () => selectDialogueOption(scene, option);
                dialogueList.appendChild(li);
            });

            dialogueBox.appendChild(dialogueList);
            document.getElementById("scene-container").insertBefore(dialogueBox, document.getElementById("navigation"));
        }

        const playerName = "Silvie";  // Player's main character name

        function selectDialogueOption(scene, option) {
            chosenDialogues.add(option.id);

            let contentContainer = document.getElementById("content-container");
            
            // Clear previous scene text so only dialogue remains
            contentContainer.innerHTML = "";

            // Create player's dialogue
            let playerChoice = document.createElement("p");
            playerChoice.className = "scene-text";
            playerChoice.innerText = `${playerName} — ${option.text}`;
            playerChoice.style.opacity = "1"; // Show immediately
            contentContainer.appendChild(playerChoice);

            // Create NPC response but keep it hidden initially
            let npcResponse = document.createElement("p");
            npcResponse.className = "scene-text";
            npcResponse.innerText = `${option.character} — ${option.response}`;
            npcResponse.style.opacity = "0"; // Start hidden
            contentContainer.appendChild(npcResponse);

            // Fade in NPC response after a short delay
            setTimeout(() => {
                npcResponse.style.transition = "opacity 0.5s";
                npcResponse.style.opacity = "1";
            }, 500);

            // Re-render dialogue to remove chosen option
            document.querySelector(".dialogue").remove();
            renderDialogue(scene);
        }

        function saveGame() {
            const saveData = { currentScene, chosenDialogues: Array.from(chosenDialogues) };
            const blob = new Blob([JSON.stringify(saveData)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "savegame.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function loadGame(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const saveData = JSON.parse(e.target.result);
                currentScene = saveData.currentScene;
                chosenDialogues = new Set(saveData.chosenDialogues);
                startGame();
            };
            reader.readAsText(file);
        }

    </script>

</body>
</html>